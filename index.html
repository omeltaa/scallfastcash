<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCALLORDER — Commandes</title>
  <link rel="icon" type="image/png" href="sallfreeze.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f19; --panel:#0f1629; --card:#111827; --ink:#ffffff; --muted:#9aa4b2; --line:#1f2937;
      --blue:#4f7cff; --green:#22c55e; --danger:#f87171; --chip:#0b1222;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--ink)}

    /* Topbar */

    .top-left{justify-self:start}
    .top-center{justify-self:center}
    .top-right{justify-self:end;display:flex;gap:8px;align-items:center}
    .nav{display:flex;gap:8px;flex-wrap:wrap}

    
    .logo-img{
        width:84px;
        height:84px;
        object-fit:contain;
        background:transparent;
    }

    .topbar{
      position:sticky;top:0;z-index:80;
      background:var(--panel);border-bottom:1px solid var(--line);
      display:grid;grid-template-columns:1fr auto 1fr;align-items:center;
      gap:12px;padding:10px 16px
    }
    .brand{display:flex;align-items:center;justify-content:center}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#223056,#3b82f6);display:grid;place-items:center;color:#fff;font-size:13px}
    .nav{display:flex;gap:8px;margin-left:12px;flex-wrap:wrap}
    .tab{appearance:none;border:1px solid var(--line);background:#0c1324;color:#cbd5e1;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
    .tab.active{background:var(--blue);color:#0b0f19;border-color:transparent}
    .spacer{flex:1}
    .btn{appearance:none;border:1px solid var(--line);background:#0c1324;color:#e5e7eb;border-radius:10px;padding:9px 12px;font-weight:700;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:var(--blue);color:#0b0f19;border-color:transparent}
    /* Line builder */
    #lineBuilder{display:grid;grid-template-columns:2fr .7fr 1fr .8fr auto;gap:8px;align-items:end;margin-bottom:8px}
    #lineBuilder input,#lineBuilder select{height:40px}
    .btn.danger{background:var(--danger);color:#0b0f19;border-color:transparent}
    .btn.xs{padding:4px 8px;font-size:12px;border-radius:8px}
    #linesTable td,#linesTable th{vertical-align:middle}
    

    .wrap{max-width:1400px;margin:0 auto;padding:18px}

    /* KPI bar */
    .kpis{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;margin:12px 0 16px}
    .kpi{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .kpi .label{color:var(--muted);font-weight:700;font-size:12px}
    .kpi .value{font-size:24px;font-weight:800;margin-top:6px}

    /* Board */
    .board{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;align-items:start}
    .col{background:var(--panel);border:1px dashed var(--line);border-radius:14px;padding:10px;min-height:420px}
    .col h3{margin:2px 2px 10px;font-size:15px;display:flex;align-items:center;justify-content:space-between;color:#e5e7eb}
    .pill{font-size:12px;padding:4px 10px;border-radius:999px;background:#0c1324;color:#cbd5e1;font-weight:800;border:1px solid var(--line)}

    .group{background:var(--card);border:1px solid var(--line);border-radius:12px;margin:8px 0;padding:6px}
    .group h4{margin:6px 8px 8px;font-size:13px;color:#cbd5e1}
    .group .list{padding:0 6px 8px}

    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin:10px 4px;cursor:grab}
    .card.dragging{opacity:.6}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .site{font-size:11px;font-weight:800;color:#0b0f19;border-radius:8px;padding:4px 8px}
    .site--vitry{background:#34d399}
    .site--raincy{background:#60a5fa}
    .title{font-weight:800;color:#fff}
    .muted{color:var(--muted);font-size:13px}
    .meta{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .chip{font-size:11px;border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:var(--chip);color:#e5e7eb}
    .late{background:rgba(248,113,113,.12);color:var(--danger);border-color:rgba(248,113,113,.35)}

    .empty{display:grid;place-items:center;color:var(--muted);height:160px;border:1px dashed var(--line);border-radius:12px;background:var(--panel)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:100}
    .modal.open{display:flex}
    .sheet{width:min(860px,95vw);background:var(--panel);color:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .sheet header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .sheet .body{padding:16px;display:grid;gap:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    input[type="text"], input[type="email"], input[type="tel"], input[type="datetime-local"], input[type="date"], input[type="time"], textarea, select{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;background:#0c1324;color:#e5e7eb}
    textarea{min-height:96px;resize:vertical}
    .sheet footer{padding:14px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:10px}

    /* Lists */
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    td{background:var(--card);color:#e5e7eb;border-top:1px solid var(--line);border-bottom:1px solid var(--line);padding:12px 14px}
    td:first-child{border-left:1px solid var(--line);border-radius:12px 0 0 12px}
    td:last-child{border-right:1px solid var(--line);border-radius:0 12px 12px 0}

    /* Production view */
    .kitchen{display:grid;grid-template-columns:1fr;gap:14px}
    .day{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
    .day h4{margin:0 0 8px;color:#cbd5e1;font-size:13px;display:flex;justify-content:space-between;align-items:center}
    .ticket{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:8px 0}
    .ticket .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .ticket .items{font-size:18px;font-weight:800;line-height:1.35}
    .ready{display:flex;align-items:center;gap:8px;margin-top:10px;color:#e5e7eb}

    .line-ready{opacity:.6}
    .ready input{width:18px;height:18px}

    .drop.hover{outline:2px dashed #3b82f6; outline-offset:2px; border-radius:12px; min-height:40px}

    @media (max-width:1100px){ .kpis{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:1000px){ .board{grid-template-columns:1fr} .grid{grid-template-columns:1fr} .kitchen{grid-template-columns:1fr} }
  
    .catwrap{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .catchip{font-size:11px;border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#162036;color:#e5e7eb}
    .subcat{margin:6px 0 2px;color:#94a3b8;font-weight:800;font-size:12px}
    

/* === Production filters + line editor (light) === */
.catbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
.catbtn{appearance:none;border:1px solid var(--line);background:#0c1324;color:#cbd5e1;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
.catbtn.active{background:#334155;color:#fff}
.hidden{display:none!important}

.lines-box{border:1px dashed #1f2937;border-radius:12px;padding:8px}
.lines-grid{display:grid;grid-template-columns: 34% 12% 16% 18% 20%;gap:8px;align-items:center}
.lines-grid .hdr{color:#94a3b8;font-size:12px}
.lines-row{display:contents}
.lines-grid input, .lines-grid textarea, .lines-grid select{width:100%;border:1px solid #1f2937;border-radius:10px;padding:10px;background:#0c1324;color:#e5e7eb}
.lines-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.lines-pill{font-size:12px;padding:4px 10px;border-radius:999px;background:#0c1324;color:#cbd5e1;font-weight:800;border:1px solid #1f2937}
.lines-sums{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}

</style>

  <style id="mobile-toggle-css">
    /* Checkbox caché */
    #mobileToggle{position:absolute;opacity:0;pointer-events:none}
    /* Bouton */
    #mobileToggleLabel{
      display:inline-flex;align-items:center;gap:.5rem;
      padding:8px 12px;border:1px solid var(--line,#e5e7eb);border-radius:10px;
      font-weight:600;cursor:pointer;user-select:none;white-space:nowrap;
    }
    #mobileToggleLabel::after{content:""}
    body:has(#mobileToggle:checked) #mobileToggleLabel{
      background:var(--blue,#0b2f5b);color:#fff;border-color:transparent
    }
    body:has(#mobileToggle:checked) #mobileToggleLabel::after{content:" ON"}
    /* Topbar compacte */
    body:has(#mobileToggle:checked) .topbar{grid-template-columns:1fr;row-gap:8px}
    body:has(#mobileToggle:checked) .top-left,
    body:has(#mobileToggle:checked) .top-center,
    body:has(#mobileToggle:checked) .top-right{justify-self:stretch}
    body:has(#mobileToggle:checked) .top-right{display:flex;flex-wrap:wrap;gap:8px}
    body:has(#mobileToggle:checked) .logo-img{max-height:28px;width:auto;height:28px}
    /* Grilles principales en 1 colonne */
    body:has(#mobileToggle:checked) .board{grid-template-columns:1fr !important}
    body:has(#mobileToggle:checked) .kitchen{display:grid;grid-template-columns:1fr !important;gap:12px}
    body:has(#mobileToggle:checked) .kpis{grid-template-columns:1fr 1fr !important}
    @media (max-width:480px){
      body:has(#mobileToggle:checked) .kpis{grid-template-columns:1fr !important}
    }
    /* Cartes compactes et clic confortable */
    body:has(#mobileToggle:checked) .col{min-height:auto}
    body:has(#mobileToggle:checked) .card{margin:8px 0;padding:10px;border-radius:12px}
    body:has(#mobileToggle:checked) .btn{padding:10px 12px;font-size:14px;border-radius:10px}
    body:has(#mobileToggle:checked) input,
    body:has(#mobileToggle:checked) select,
    body:has(#mobileToggle:checked) textarea{min-height:42px}
    /* Éditeur de lignes en colonne */
    body:has(#mobileToggle:checked) #lineBuilder{grid-template-columns:1fr !important}
    body:has(#mobileToggle:checked) .lines-grid{grid-template-columns:1fr !important}
    body:has(#mobileToggle:checked) .lines-grid > *{min-height:42px}
  </style>


  <style id="patch-mobile-css">
    /* Formulaires/modales scrollables */
    .modal{padding:16px}
    .sheet{max-height:90vh;overflow:auto}
    .sheet > header{position:sticky;top:0;z-index:2;background:var(--panel)}
    .sheet > .body{max-height:calc(90vh - 56px);overflow:auto}

    /* Cacher le logo image en version mobile + compacter la topbar + menu hamburger */
    @media (max-width: 820px){
      .topbar{grid-template-columns: 1fr auto !important; gap:8px}
      .top-center .brand, .top-center .logo-img{display:none !important}
      .top-left .nav{display:none !important}
      .top-right .btn{display:none}
      #hamburger{display:inline-flex !important}
    }

    /* Panneau menu mobile */
    #hamburger{display:none; align-items:center; justify-content:center; gap:.5rem}
    #mobileMenu{position:fixed; inset:0; display:none; z-index:120;
      background:rgba(0,0,0,.6); backdrop-filter:saturate(160%) blur(2px);}
    #mobileMenu .panel{position:absolute; right:0; top:0; height:100%; width:min(86vw, 360px);
      background:var(--panel); border-left:1px solid var(--line); padding:16px; overflow:auto}
    #mobileMenu h3{margin:0 0 12px 0; font-size:18px}
    #mobileMenu .menu-grid{display:grid; grid-auto-rows:minmax(44px, auto); gap:8px}
    #mobileMenu .menu-grid .tab, #mobileMenu .menu-grid .btn{width:100%; text-align:left}

    /* Quand ouvert */
    body.menu-open{overflow:hidden}
    body.menu-open #mobileMenu{display:block}
  </style>

</head>
<body>
  <header class="topbar">
  <div class="top-left">
    <nav class="nav" role="tablist" aria-label="Sections">
      <button class="tab active" data-tab="board">Tableau</button>
      <button class="tab" data-tab="kitchen">Production</button>
      <button class="tab" data-tab="clients">Clients</button>
      <button class="tab" data-tab="staff">Employés</button>
      <button class="tab" data-tab="stats">Stats</button>
    </nav>
  </div>
  <div class="top-center">
    <div class="brand"><img class="logo-img" src="sallfreeze.png" alt="SCALLORDER logo"></div>
  </div>
  <div class="top-right">
    <button class="btn" id="hamburger" aria-expanded="false" aria-controls="mobileMenu" title="Menu">☰</button>
      <input type="checkbox" id="mobileToggle" />
      <label for="mobileToggle" id="mobileToggleLabel" class="btn" title="Basculer l’affichage mobile">📱 Mobile</label>

    <button class="btn" id="addClient">+ Client</button>
    <button class="btn" id="addStaff">+ Employé</button>
    <button class="btn" id="exportCsv">Export CSV</button>
    <button class="btn primary" id="openNewOrder">+ Nouvelle commande</button>
  </div>
</header>
<div id="mobileMenu" aria-hidden="true">
  <div class="panel">
    <h3>Navigation</h3>
    <div class="menu-grid">
      <button class="tab" data-menu-tab="board">Tableau</button>
      <button class="tab" data-menu-tab="kitchen">Production</button>
      <button class="tab" data-menu-tab="clients">Clients</button>
      <button class="tab" data-menu-tab="staff">Employés</button>
      <button class="tab" data-menu-tab="stats">Stats</button>
      <hr/>
      <button class="btn" data-menu-click="#addClient">+ Client</button>
      <button class="btn" data-menu-click="#addStaff">+ Employé</button>
      <button class="btn" data-menu-click="#exportCsv">Export CSV</button>
      <button class="btn primary" data-menu-click="#openNewOrder">+ Nouvelle commande</button>
    </div>
  </div>
</div>


  <main class="wrap">
    <section class="kpis" id="kpiBar">
      <div class="kpi"><div class="label">Commandes du jour</div><div class="value" id="kpi-today">0</div></div>
      <div class="kpi"><div class="label">En retard</div><div class="value" id="kpi-late">0</div></div>
      <div class="kpi"><div class="label">À préparer</div><div class="value" id="kpi-prep">0</div></div>
      <div class="kpi"><div class="label">Prêtes</div><div class="value" id="kpi-ready">0</div></div>
      <div class="kpi"><div class="label">CA estimé</div><div class="value" id="kpi-rev">0€</div></div>
    </section>

    <section id="board" class="board" aria-label="Tableau des commandes">
      <div class="col" data-status="a_valider">
        <h3>À valider <span class="pill" id="count-a_valider">0</span></h3>
        <div class="drop" data-dropzone="a_valider"></div>
      </div>
      <div class="col" data-status="a_preparer">
        <h3>À préparer <span class="pill" id="count-a_preparer">0</span></h3>
        <div class="drop" data-dropzone="a_preparer"></div>
      </div>
      <div class="col" data-status="a_livrer">
        <h3>À livrer <span class="pill" id="count-a_livrer">0</span></h3>
        <div class="drop" data-dropzone="a_livrer"></div>
      </div>
    </section>

    <section id="kitchen" class="kitchen" style="display:none"></section>

    <section id="clients" style="display:none">
      <div class="kpi" style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center"><strong>Clients</strong><button class="btn" id="addClient2">+ Ajouter</button></div>
      <div id="clientTable"></div>
    </section>

    <section id="staff" style="display:none">
      <div class="kpi" style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center"><strong>Employés</strong><button class="btn" id="addStaff2">+ Ajouter</button></div>
      <div id="staffTable"></div>
    </section>

    <section id="stats" style="display:none">
      <div class="kpi" style="margin-bottom:12px"><strong>Stats</strong></div>
      <div id="statsBox" class="grid"></div>
    </section>
  </main>

  <!-- Modals -->
  <div class="modal" id="newOrderModal" aria-hidden="true" aria-label="Nouvelle commande">
    <div class="sheet" role="dialog" aria-modal="true">
      <header>
        <strong>Nouvelle commande</strong>
        <button class="btn" id="closeModal">Fermer</button>
      </header>
      <div class="body">
        <div class="grid">
          <div>
            <label>Client</label>
            <input id="fClient" type="text" placeholder="Nom & Prénom" />
          </div>
          <div>
            <label>Site</label>
            <select id="fSite"><option>Vitry</option><option>Raincy</option><option>Vitry 2</option><option>Montreuil</option></select>
          </div>
          <div>
            <label>Date de livraison / retrait</label>
            <input id="fDate" type="date" />
          </div>
          <div>
            <label>Heure</label>
            <input id="fTime" type="time" />
          </div>
        </div>
        
<div>
  <label>Produits</label>
  <div id="lineBuilder">
    <input id="lineName" type="text" placeholder="Dénomination (ex: baguette)" />
    <input id="lineQty" type="number" min="1" step="1" value="1" placeholder="Qté" />
    <select id="lineCat" aria-label="Catégorie"></select>
    <input id="linePrice" type="number" min="0" step="0.01" placeholder="Prix (€)" />
    <button class="btn" id="addLine">+ Ajouter ligne</button>
  </div>
  <div id="linesTable"></div>
  <!-- On garde fItems pour compat, on le remplit automatiquement -->
  <textarea id="fItems" style="display:none" placeholder="Ex: 1 baguette; 2 croissants; 1 tradition"></textarea>
</div>

        <div class="grid">
          <div>
            <label>Type</label>
            <select id="fType"><option value="retrait">Retrait</option><option value="livraison">Livraison</option></select>
          </div>
          <div>
            <label>Montant estimé (€)</label>
            <input id="fAmount" type="text" placeholder="0" />
          </div>
        </div>
        <div class="grid">
          <div>
            <label>Pris par (employé)</label>
            <select id="fTakenBy"></select>
          </div>
          <div>
            <label>Commentaire</label>
            <input id="fNote" type="text" placeholder="Allergènes / infos…" />
          </div>
        </div>
      </div>
      <footer>
        <button class="btn" id="resetForm">Réinitialiser</button>
        <button class="btn primary" id="saveOrder">Enregistrer</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="confirmModal" aria-hidden="true" aria-label="Confirmer le changement de statut">
    <div class="sheet" role="dialog" aria-modal="true">
      <header>
        <strong>Confirmer le changement de statut</strong>
        <button class="btn" id="closeConfirm">Fermer</button>
      </header>
      <div class="body">
        <p class="muted" id="confirmText">Voulez-vous vraiment déplacer cette commande ?</p>
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="confirmCheck"> <span>Oui, je confirme le changement de statut.</span></label>
      </div>
      <footer>
        <button class="btn" id="cancelConfirm">Annuler</button>
        <button class="btn primary" id="confirmBtn" disabled>Confirmer</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="orderModal" aria-hidden="true" aria-label="Détails commande">
    <div class="sheet" role="dialog" aria-modal="true">
      <header>
        <strong id="omTitle">Commande</strong>
        <button class="btn" id="omClose">Fermer</button>
      </header>
      <div class="body">
        <div class="grid">
          <div><label>Client</label><input id="omClient" type="text" /></div>
          <div><label>Site</label><select id="omSite"><option>Vitry</option><option>Raincy</option><option>Vitry 2</option><option>Montreuil</option></select></div>
          <div><label>Date</label><input id="omDate" type="date" /></div>
          <div><label>Heure</label><input id="omTime" type="time" /></div>
          <div><label>Type</label><select id="omType"><option value="retrait">Retrait</option><option value="livraison">Livraison</option></select></div>
          <div><label>Montant (€)</label><input id="omAmount" type="text" /></div>
          <div><label>Statut</label><select id="omStatus"><option value="a_valider">À valider</option><option value="a_preparer">À préparer</option><option value="a_livrer">À livrer</option></select></div>
          <div><label>Pris par</label><select id="omTakenBy"></select></div>
        </div>
        <div><label>Produits</label><textarea id="omItems"></textarea></div>
        <div><label>Commentaire</label><textarea id="omNote"></textarea></div>
      </div>
      <footer>
        <button class="btn" id="omDelete">Supprimer</button>
        <button class="btn primary" id="omSave">Enregistrer</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="clientModal" aria-hidden="true" aria-label="Détails client">
    <div class="sheet" role="dialog" aria-modal="true">
      <header>
        <strong id="cmTitle">Client</strong>
        <button class="btn" id="cmClose">Fermer</button>
      </header>
      <div class="body">
        <div class="grid">
          <div><label>Nom</label><input id="cmName" type="text" /></div>
          <div><label>Email</label><input id="cmEmail" type="email" /></div>
          <div><label>Téléphone</label><input id="cmPhone" type="tel" /></div>
          <div><label>Type</label><select id="cmType"><option>Client</option><option>Professionnel</option></select></div>
        </div>
        <div>
          <strong>Commandes précédentes</strong>
          <div id="cmOrders"></div>
        </div>
      </div>
      <footer>
        <button class="btn" id="cmDelete">Supprimer</button>
        <button class="btn primary" id="cmSave">Enregistrer</button>
      </footer>
    </div>
  </div>

  <div class="modal" id="staffModal" aria-hidden="true" aria-label="Détails employé">
    <div class="sheet" role="dialog" aria-modal="true">
      <header>
        <strong id="smTitle">Employé</strong>
        <button class="btn" id="smClose">Fermer</button>
      </header>
      <div class="body">
        <div class="grid">
          <div><label>Nom</label><input id="smName" type="text" /></div>
          <div><label>Site</label><select id="smSite"><option>Vitry</option><option>Raincy</option><option>Vitry 2</option><option>Montreuil</option></select></div>
          <div><label>Rôle</label><input id="smRole" type="text" /></div>
          <div><label>Email</label><input id="smEmail" type="email" /></div>
        </div>
        <div><strong>Commandes prises</strong><div id="smOrders"></div></div>
      </div>
      <footer>
        <button class="btn" id="smDelete">Supprimer</button>
        <button class="btn primary" id="smSave">Enregistrer</button>
      </footer>
    </div>
  </div>

  <script>
    // --- Security & formatting ---
    const fmtEUR=new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});
    const esc=(s)=>String(s??'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

    // --- Storage ---
    const K_ORDERS='scallorder.orders', K_CLIENTS='scallorder.clients', K_STAFF='scallorder.staff';
    let orders=[], clients=[], staff=[];
    const state={ q:'', site:'', type:'', status:'', from:'', to:'', emp:'', client:'', late:false };

    // --- Dates (local, no UTC drift) ---
    const parseYmd=(s)=>{ const [y,m,d]=(s||'').split('-').map(Number); return new Date(y||1970,(m||1)-1,d||1); };
    const todayYmd=(()=>{ const t=new Date(); return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`; })();
    const isToday=(d)=>{ const a=parseYmd(d), t=parseYmd(todayYmd); return a.getTime()===t.getTime(); };
    const isLate=(d,time='23:59')=>{ const [h,m]=(time||'23:59').split(':').map(Number); const dt=parseYmd(d); dt.setHours(h||23,m||59,0,0); return dt.getTime()<Date.now(); };
    const formatDate=(d)=>{ const dd=parseYmd(d); return isNaN(dd)?'—':dd.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'}); };
    const labelDate=(d)=>{ const dd=parseYmd(d), td=parseYmd(todayYmd); const delta=Math.round((dd-td)/86400000); if(delta===0) return "Aujourd'hui"; if(delta===1) return 'Demain'; return dd.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'short'}); };
    const todayISO=(offset=0)=>{ const t=parseYmd(todayYmd); t.setDate(t.getDate()+offset); return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`; };

    function load(){
      try{
        orders=JSON.parse(localStorage.getItem(K_ORDERS)||'[]');
        clients=JSON.parse(localStorage.getItem(K_CLIENTS)||'[]');
        staff=JSON.parse(localStorage.getItem(K_STAFF)||'[]');
      }catch{ orders=[]; clients=[]; staff=[]; }
      if(!orders.length){
        orders=[
          {id:'1', site:'Vitry', customer:'Robert Wilson', items:'1 baguette · 1 croissant · 1 tradition', date:todayISO(), time:'10:00', type:'livraison', amount:9.2, status:'a_preparer', note:'', takenBy:'1'},
          {id:'2', site:'Vitry', customer:'Lisa Miller', items:'2 traditions · 1 flan', date:todayISO(1), time:'12:00', type:'retrait', amount:14.8, status:'a_valider', note:'', takenBy:'2'},
          {id:'3', site:'Raincy', customer:'Jane Smith', items:'6 pains au chocolat', date:todayISO(), time:'08:30', type:'retrait', amount:7.2, status:'a_livrer', note:'', takenBy:'3'}
        ];
      }
      if(!clients.length){
        clients=[
          {id:'c1', name:'Robert Wilson', email:'robert.wilson@example.com', phone:'', type:'Professionnel'},
          {id:'c2', name:'Lisa Miller', email:'lisa.miller@example.com', phone:'', type:'Client'},
          {id:'c3', name:'Jane Smith', email:'jane.smith@example.com', phone:'', type:'Client'}
        ];
      }
      if(!staff.length){
        staff=[
          {id:'1', name:'Dihya', site:'Raincy', role:'Alternant Vente', email:''},
          {id:'2', name:'Mara', site:'Raincy', role:'Vendeuse', email:''},
          {id:'3', name:'Mélissa', site:'Vitry', role:'Responsable Gérant', email:'mel@example.com'}
        ];
      }
      save();
    }
    const save=()=>{ localStorage.setItem(K_ORDERS,JSON.stringify(orders)); localStorage.setItem(K_CLIENTS,JSON.stringify(clients)); localStorage.setItem(K_STAFF,JSON.stringify(staff)); };

    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active'); const tab=btn.dataset.tab;
        ['board','kitchen','clients','staff','stats'].forEach(id=>{ const el=document.getElementById(id); el.style.display=(id===tab?(id==='board'?'grid':'block'):'none'); });
        if(tab==='clients') renderClients(); if(tab==='staff') renderStaff(); if(tab==='stats') renderStats(); if(tab==='kitchen') renderKitchen();
      });
    });

    // Helpers
    const byId=(id)=>document.getElementById(id);
    const val=(id)=>byId(id)?.value||'';
    const setVal=(id,v)=>{ const el=byId(id); if(el) el.value=v; };

    // Filters (no UI yet, but function supports state)
    function passFilters(o){
      if(state.site && String(o.site).toLowerCase()!==String(state.site).toLowerCase()) return false;
      if(state.status && o.status!==state.status) return false;
      if(state.type && o.type!==state.type) return false;
      if(state.emp && o.takenBy!==state.emp) return false;
      if(state.client && String(o.customer).toLowerCase().indexOf(String(state.client).toLowerCase())===-1) return false;
      if(state.from && parseYmd(o.date)<parseYmd(state.from)) return false;
      if(state.to && parseYmd(o.date)>parseYmd(state.to)) return false;
      if(state.late && !isLate(o.date,o.time)) return false;
      if(state.q){
        const q=state.q.toLowerCase();
        const hay=[o.customer,o.items,o.site,o.type,o.status].map(x=>String(x||'').toLowerCase()).join('|');
        if(!hay.includes(q)) return false;
      }
      return true;
    }

    // Board
    const dropzones=document.querySelectorAll('[data-dropzone]');

    function cardHTML(o){
      const siteCls=`site site--${String(o.site||'').toLowerCase()}`;
      const archive=(o.status==='a_livrer' && !o.archivedAt)
        ? `<label class="ready"><input type="checkbox" data-archive="${esc(o.id)}"> Livré (archiver)</label>` : '';
      return `
        <div class="row"><span class="${siteCls}">${esc(o.site||'')}</span><span class="muted">${esc(o.type||'')}</span></div>
        <div class="title" style="margin-top:6px">${esc(o.customer||'')}</div>
        <div class="muted">${esc(o.items||'')}</div>
        <div class="meta">
          <span class="chip">${formatDate(o.date)} ${esc(o.time||'')}</span>
          <span class="chip">${fmtEUR.format(Number(o.amount||0))}</span>
          ${isLate(o.date,o.time)? '<span class="chip late">Retard</span>' : ''}
        </div>
        ${archive}`;
    }

    function renderBoard(){
      dropzones.forEach(z=>z.innerHTML='');
      let kToday=0,kLate=0,kPrep=0,kReady=0,kRev=0;
      const buckets={ a_valider:new Map(), a_preparer:new Map(), a_livrer:new Map() };
      const pushTo=(o)=>{ if(!passFilters(o) || o.archivedAt) return; const k=o.date||todayISO(); const m=buckets[o.status]; if(!m) return; if(!m.has(k)) m.set(k,[]); m.get(k).push(o); };
      orders.filter(o=>!o.archivedAt).forEach(o=>{ if(isToday(o.date)) kToday++; if(isLate(o.date,o.time)) kLate++; if(o.status==='a_preparer') kPrep++; if(o.status==='a_livrer') kReady++; kRev+=Number(o.amount||0); pushTo(o); });
      Object.entries(buckets).forEach(([status,map])=>{
        const dates=[...map.keys()].sort(); const zone=document.querySelector(`[data-dropzone="${status}"]`);
        if(!dates.length){ const empty=document.createElement('div'); empty.className='empty'; empty.textContent='Aucune commande'; zone.appendChild(empty); }
        dates.forEach(d=>{ const group=document.createElement('div'); group.className='group'; group.innerHTML=`<h4>${labelDate(d)} · <span class="pill">${map.get(d).length}</span></h4><div class="list"></div>`; const list=group.querySelector('.list'); map.get(d).forEach(o=>{ const card=document.createElement('article'); card.className='card'; card.draggable=true; card.dataset.id=o.id; card.innerHTML=cardHTML(o); card.addEventListener('dragstart',()=>card.classList.add('dragging')); card.addEventListener('dragend',()=>card.classList.remove('dragging')); card.addEventListener('click',()=>openOrderModal(o.id)); list.appendChild(card); }); zone.appendChild(group); });
        byId(`count-${status}`).textContent=dates.reduce((acc,d)=>acc+(map.get(d)?.length||0),0);
      });
      byId('kpi-today').textContent=kToday; byId('kpi-late').textContent=kLate; byId('kpi-prep').textContent=kPrep; byId('kpi-ready').textContent=kReady; byId('kpi-rev').textContent=fmtEUR.format(kRev);
      // archive checkboxes
      document.querySelectorAll('[data-archive]').forEach(cb=>{
        cb.addEventListener('change',()=>{ const id=cb.getAttribute('data-archive'); const o=orders.find(x=>String(x.id)===String(id)); if(!o) return; if(!confirm("Confirmer: marquer cette commande comme LIVRÉE et l'archiver ?")){ cb.checked=false; return; } o.archivedAt=new Date().toISOString(); save(); renderBoard(); });
      });
      renderStats();
    }

    // DnD with confirm modal (no visual pre-move)
    let pendingChange=null;
    function openStatusConfirm(id,to){ pendingChange={id,toStatus:to}; byId('confirmText').textContent=`Déplacer la commande #${esc(id)} vers "${labelStatus(to)}" ?`; byId('confirmCheck').checked=false; byId('confirmBtn').disabled=true; openModalGeneric('confirmModal'); }
    function closeStatusConfirm(){ closeModalGeneric('confirmModal'); pendingChange=null; renderBoard(); }
    function labelStatus(s){ return s==='a_valider'?'À valider':(s==='a_preparer'?'À préparer':'À livrer'); }
    byId('confirmCheck').addEventListener('change',e=>{ byId('confirmBtn').disabled=!e.target.checked; });
    byId('cancelConfirm').addEventListener('click',closeStatusConfirm);
    byId('closeConfirm').addEventListener('click',closeStatusConfirm);
    byId('confirmBtn').addEventListener('click',()=>{ if(!pendingChange) return; const o=orders.find(x=>String(x.id)===String(pendingChange.id)); if(o){ o.status=pendingChange.toStatus; save(); } closeStatusConfirm(); renderBoard(); });

    document.querySelectorAll('[data-dropzone]').forEach(zone=>{
      zone.addEventListener('dragover',e=>{ e.preventDefault(); zone.classList.add('hover'); });
      zone.addEventListener('dragleave',()=>zone.classList.remove('hover'));
      zone.addEventListener('drop',()=>{ zone.classList.remove('hover'); const dragging=document.querySelector('.card.dragging'); if(!dragging) return; openStatusConfirm(dragging.dataset.id, zone.dataset.dropzone); });
    });

    // Production (hide a_valider & archived)
    function renderKitchen(){
      const host=byId('kitchen'); host.innerHTML='';
      const groups=new Map();
      orders.filter(o=>!o.archivedAt && o.status!=='a_valider').forEach(o=>{ if(!passFilters(o)) return; const k=o.date; if(!groups.has(k)) groups.set(k,[]); groups.get(k).push(o); });
      const dates=[...groups.keys()].sort();
      if(!dates.length){ const d=document.createElement('div'); d.className='empty'; d.textContent='Aucune commande'; host.appendChild(d); return; }
      dates.forEach(d=>{
        const day=document.createElement('section'); day.className='day'; const list=groups.get(d).sort((a,b)=> { const aa=parseYmd(a.date); aa.setHours(...(a.time||'23:59').split(':').map(Number)); const bb=parseYmd(b.date); bb.setHours(...(b.time||'23:59').split(':').map(Number)); return aa-bb; }); day.innerHTML=`<h4>${labelDate(d)} <span class="pill">${list.length}</span></h4>`;
        list.forEach(o=>{ const t=document.createElement('article'); t.className='ticket'; t.innerHTML=`
          <div class="head"><div><span class="site site--${esc(String(o.site||'').toLowerCase())}">${esc(o.site)}</span> <strong style="margin-left:6px">${esc(o.customer)}</strong></div><div class="muted">${formatDate(o.date)} ${esc(o.time||'')}</div></div>
          <div class="items">${esc(o.items)}</div>
          <label class="ready"><input type="checkbox" data-ready-toggle data-id="${esc(o.id)}" ${o.status==='a_livrer'?'checked':''}/> Commande prête</label>`; day.appendChild(t); }); host.appendChild(day);
      });
      host.querySelectorAll('[data-ready-toggle]').forEach(cb=>{ cb.addEventListener('change',()=>{ const o=orders.find(x=>String(x.id)===String(cb.dataset.id)); if(!o) return; if(cb.checked){ o.status='a_livrer'; o.readyAt=new Date().toISOString(); } else { o.status='a_preparer'; o.readyAt=null; } save(); renderBoard(); renderKitchen(); }); });
    }

    // Order modal
    let currentOrderId=null;
    function openOrderModal(id){ currentOrderId=id; const o=orders.find(x=>String(x.id)===String(id)); if(!o) return; byId('omTitle').textContent=`Commande #${esc(o.id)}`; setVal('omClient',o.customer); setVal('omSite',o.site); setVal('omDate',o.date); setVal('omTime',o.time); setVal('omType',o.type); setVal('omAmount',String(o.amount||0)); setVal('omStatus',o.status); setVal('omItems',o.items); setVal('omNote',o.note||''); fillEmployeeSelect('omTakenBy'); setVal('omTakenBy',o.takenBy||''); openModalGeneric('orderModal'); }
    byId('omClose').addEventListener('click',()=>closeModalGeneric('orderModal'));
    byId('omSave').addEventListener('click',()=>{ const o=orders.find(x=>String(x.id)===String(currentOrderId)); if(!o) return; o.customer=val('omClient'); o.site=val('omSite'); o.date=val('omDate'); o.time=val('omTime'); o.type=val('omType'); o.amount=Number(val('omAmount')||0); o.status=val('omStatus'); o.items=val('omItems'); o.note=val('omNote'); o.takenBy=val('omTakenBy'); save(); closeModalGeneric('orderModal'); renderBoard(); renderKitchen(); });
    byId('omDelete').addEventListener('click',()=>{ if(!confirm('Supprimer cette commande ?')) return; orders=orders.filter(x=>String(x.id)!==String(currentOrderId)); save(); closeModalGeneric('orderModal'); renderBoard(); renderKitchen(); });

    // Clients
    function renderClients(){
      const host=byId('clientTable'); host.innerHTML=''; const tbl=document.createElement('table');
      clients.forEach(c=>{
        const tr=document.createElement('tr');
        const typeBadge = `<span class="chip" style="background:${c.type==='Professionnel'?'#fff7ed':'#fee2e2'};border-color:transparent;color:${c.type==='Professionnel'?'#b45309':'#b91c1c'};font-weight:800">${esc(c.type||'Client')}</span>`;
        tr.innerHTML=`<td style="width:140px">${typeBadge}</td><td style="font-weight:800">${esc(c.name)}</td><td class="muted">${esc(c.email||'—')}</td><td class="muted">${esc(c.phone||'—')}</td><td style="text-align:right"><button class="btn" data-open-client="${esc(c.id)}">Ouvrir</button></td>`;
        tbl.appendChild(tr);
      });
      host.appendChild(tbl);
      host.querySelectorAll('[data-open-client]').forEach(btn=>btn.addEventListener('click',()=>openClientModal(btn.dataset.openClient)));
    }
    byId('addClient').addEventListener('click',()=>newClient()); byId('addClient2').addEventListener('click',()=>newClient());
    let currentClientId=null; function newClient(){ currentClientId=null; setVal('cmName',''); setVal('cmEmail',''); setVal('cmPhone',''); setVal('cmType','Client'); byId('cmTitle').textContent='Nouveau client'; openModalGeneric('clientModal'); }
    function openClientModal(id){ currentClientId=id; const c=clients.find(x=>String(x.id)===String(id)); if(!c) return; setVal('cmName',c.name); setVal('cmEmail',c.email||''); setVal('cmPhone',c.phone||''); setVal('cmType',c.type||'Client'); byId('cmTitle').textContent=esc(c.name); const list=byId('cmOrders'); list.innerHTML=''; orders.filter(o=>o.customer===c.name).forEach(o=>{ const item=document.createElement('div'); item.className='card'; item.innerHTML=cardHTML(o); item.style.cursor='pointer'; item.addEventListener('click',()=>openOrderModal(o.id)); list.appendChild(item); }); openModalGeneric('clientModal'); }
    byId('cmClose').addEventListener('click',()=>closeModalGeneric('clientModal'));
    byId('cmSave').addEventListener('click',()=>{ if(currentClientId){ const c=clients.find(x=>String(x.id)===String(currentClientId)); if(!c) return; const old=c.name; c.name=val('cmName'); c.email=val('cmEmail'); c.phone=val('cmPhone'); c.type=val('cmType'); orders.forEach(o=>{ if(o.customer===old) o.customer=c.name; }); } else { const id='c'+Date.now(); clients.push({id, name:val('cmName')||'Client', email:val('cmEmail')||'', phone:val('cmPhone')||'', type:val('cmType')||'Client'}); } save(); renderClients(); renderBoard(); renderKitchen(); closeModalGeneric('clientModal'); });

    // Staff
    function renderStaff(){
      const host=byId('staffTable'); host.innerHTML=''; const tbl=document.createElement('table');
      staff.forEach(s=>{
        const tr=document.createElement('tr');
        const badge = `<span class="chip" style="background:${s.site==='Vitry'?'#e0f2fe':'#dcfce7'};border-color:transparent;color:${s.site==='Vitry'?'#0369a1':'#166534'};font-weight:800">${esc(s.site)}</span>`;
        tr.innerHTML=`<td style="width:100px">${badge}</td><td style="font-weight:800">${esc(s.name)}</td><td class="muted">${esc(s.role||'—')}</td><td class="muted">${esc(s.email||'—')}</td><td style="text-align:right"><button class="btn" data-open-staff="${esc(s.id)}">Ouvrir</button></td>`;
        tbl.appendChild(tr);
      });
      host.appendChild(tbl); host.querySelectorAll('[data-open-staff]').forEach(btn=>btn.addEventListener('click',()=>openStaffModal(btn.dataset.openStaff)));
    }
    byId('addStaff').addEventListener('click',()=>newStaff()); byId('addStaff2').addEventListener('click',()=>newStaff());
    let currentStaffId=null; function newStaff(){ currentStaffId=null; setVal('smName',''); setVal('smSite','Vitry'); setVal('smRole',''); setVal('smEmail',''); byId('smTitle').textContent='Nouvel employé'; openModalGeneric('staffModal'); }
    function openStaffModal(id){ currentStaffId=id; const s=staff.find(x=>String(x.id)===String(id)); if(!s) return; setVal('smName',s.name); setVal('smSite',s.site); setVal('smRole',s.role||''); setVal('smEmail',s.email||''); byId('smTitle').textContent=esc(s.name); const list=byId('smOrders'); list.innerHTML=''; orders.filter(o=>o.takenBy===id).forEach(o=>{ const item=document.createElement('div'); item.className='card'; item.innerHTML=cardHTML(o); item.style.cursor='pointer'; item.addEventListener('click',()=>openOrderModal(o.id)); list.appendChild(item); }); openModalGeneric('staffModal'); }
    byId('smClose').addEventListener('click',()=>closeModalGeneric('staffModal'));
    byId('smSave').addEventListener('click',()=>{ if(currentStaffId){ const s=staff.find(x=>String(x.id)===String(currentStaffId)); if(!s) return; s.name=val('smName'); s.site=val('smSite'); s.role=val('smRole'); s.email=val('smEmail'); } else { const id=String(Date.now()); staff.push({id, name:val('smName')||'Employé', site:val('smSite')||'Vitry', role:val('smRole')||'', email:val('smEmail')||''}); } save(); renderStaff(); renderBoard(); renderKitchen(); closeModalGeneric('staffModal'); });

    // Stats (dashboard + onglet)
    function renderStats(){
      try{
        let today=0, late=0, prep=0, ready=0, revenue=0;
        const perSiteCount={}, perSiteCA={};
        orders.filter(o=>!o.archivedAt).forEach(o=>{
          if(isToday(o.date)) today++;
          if(isLate(o.date,o.time)) late++;
          if(o.status==='a_preparer') prep++;
          if(o.status==='a_livrer') ready++;
          const amt=Number(o.amount||0);
          revenue+=amt;
          perSiteCount[o.site]=(perSiteCount[o.site]||0)+1;
          perSiteCA[o.site]=(perSiteCA[o.site]||0)+amt;
        });
        byId('kpi-today').textContent=today;
        byId('kpi-late').textContent=late;
        byId('kpi-prep').textContent=prep;
        byId('kpi-ready').textContent=ready;
        byId('kpi-rev').textContent=fmtEUR.format(revenue);

        const host=byId('statsBox'); if(!host) return; host.innerHTML='';
        const make=(title,val)=>{ const card=document.createElement('div'); card.className='kpi'; card.innerHTML=`<div class="label" style="color:#94a3b8">${esc(title)}</div><div class="value">${esc(val)}</div>`; return card; };
        host.appendChild(make('Commandes du jour', String(today)));
        host.appendChild(make('En retard', String(late)));
        host.appendChild(make('À préparer', String(prep)));
        host.appendChild(make('À livrer', String(ready)));
        host.appendChild(make('CA estimé', fmtEUR.format(revenue)));
        Object.entries(perSiteCount).forEach(([site,c])=>host.appendChild(make(`Commandes – ${site}`, String(c))));
        Object.entries(perSiteCA).forEach(([site,c])=>host.appendChild(make(`CA – ${site}`, fmtEUR.format(c))));
      }catch(err){ console.error('renderStats error',err); }
    }

    // Export CSV (extended)
    byId('exportCsv').addEventListener('click',()=>{
      const header=['id','site','customer','items','date','time','type','amount','status','takenBy','readyAt','archivedAt'];
      const escq=(v)=>`"${String(v ?? '').replace(/"/g,'""')}"`;
      const rows=orders.map(o=>header.map(h=>escq(o[h])).join(','));
      const csv=[header.join(','),...rows].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='scallorder_export.csv'; document.body.appendChild(a); a.click(); a.remove();
    });

    // Modal utils
    function openModalGeneric(id){ const m=byId(id); m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
    function closeModalGeneric(id){ const m=byId(id); m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }

    // New Order modal logic
    function fillEmployeeSelect(selId){ const sel=byId(selId); if(!sel) return; sel.innerHTML='<option value="">—</option>' + (staff||[]).map(s=>`<option value="${esc(s.id)}">${esc(s.name)}</option>`).join(''); }
    function openNewOrder(){ fillEmployeeSelect('fTakenBy'); openModalGeneric('newOrderModal'); }
    function closeNewOrder(){ closeModalGeneric('newOrderModal'); }
    const _btnOpenNew=byId('openNewOrder'); if(_btnOpenNew){ _btnOpenNew.addEventListener('click',openNewOrder); }
    const _btnCloseNew=byId('closeModal'); if(_btnCloseNew){ _btnCloseNew.addEventListener('click',closeNewOrder); }
    const _btnResetNew=byId('resetForm'); if(_btnResetNew){ _btnResetNew.addEventListener('click',()=>{ ['fClient','fItems','fNote','fAmount'].forEach(id=>{ const el=byId(id); if(el) el.value=''; }); const t=byId('fTakenBy'); if(t) t.value=''; }); }
    const _btnSaveNew=byId('saveOrder'); if(_btnSaveNew){ _btnSaveNew.addEventListener('click',()=>{ const id=Date.now().toString(); const o={ id, site:val('fSite')||'Vitry', customer:val('fClient')||'Client inconnu', items:val('fItems')||'—', date:val('fDate')||todayISO(), time:val('fTime')||'12:00', type:val('fType')||'retrait', amount:Number(val('fAmount')||0), status:'a_valider', note:val('fNote')||'', takenBy:val('fTakenBy')||'' }; orders.unshift(o); save(); closeNewOrder(); renderBoard(); renderKitchen(); }); }

    // --- Smoke tests (non-blocking) ---
    function runTests(){
      try{
        renderBoard(); renderKitchen();
        // Production should not show "À valider"
        const prodText = byId('kitchen').textContent || '';
        console.assert(!prodText.includes('Lisa Miller'),'Production should hide "À valider" orders');
        // CSV newline test
        const header=['id','site','customer','items','date','time','type','amount','status','takenBy'];
        const escq=(v)=>`"${String(v ?? '').replace(/"/g,'""')}"`;
        const rows=orders.map(o=>header.map(h=>escq(o[h])).join(','));
        const csv=[header.join(','),...rows].join('\n');
        console.assert(csv.includes('\n'),'CSV should contain newlines');
        // New Order modal open/close
        const btn=byId('openNewOrder'); if(btn){ btn.click(); const opened=byId('newOrderModal').classList.contains('open'); console.assert(opened,'New Order modal should open'); byId('closeModal').click(); }
      }catch(e){ console.warn('Smoke tests failed',e); }
    }

    // Init
    load();
    renderBoard();
    renderKitchen();
    runTests();
  
// --- Delete Client / Staff ---
if (document.getElementById('cmDelete')) {
  document.getElementById('cmDelete').addEventListener('click', () => {
    if (!currentClientId) { alert('Aucun client sélectionné.'); return; }
    if (!confirm('Supprimer ce client ? Les commandes existantes garderont le nom en clair.')) return;
    clients = clients.filter(x => String(x.id) !== String(currentClientId));
    save();
    closeModalGeneric('clientModal');
    renderClients();
  });
}
if (document.getElementById('smDelete')) {
  document.getElementById('smDelete').addEventListener('click', () => {
    if (!currentStaffId) { alert('Aucun employé sélectionné.'); return; }
    if (!confirm('Supprimer cet employé ? Les commandes prises par lui seront conservées, mais le champ "Pris par" sera vidé.')) return;
    const removedId = String(currentStaffId);
    staff = staff.filter(x => String(x.id) != removedId);
    orders.forEach(o => { if (String(o.takenBy) === removedId) o.takenBy = ''; });
    save();
    closeModalGeneric('staffModal');
    renderStaff();
    renderBoard();
    renderKitchen();
  });
}

</script>

<!-- per-line production script (safe, idempotent, per-line ready) -->
<script>
(function(){
  if (window.__SCALLORDER_PER_LINE_READY__) return;
  window.__SCALLORDER_PER_LINE_READY__ = true;

  const CATS = ['boulangerie','pâtisserie','traiteur','viennoiserie','boissons'];
  const RX = {
    boulangerie: /(?:\b|\s)(baguette|tradition|pain(?! au chocolat)|campagne|seigle|céréales|bâtard|ficelle|complet)(?:\b|\s)/i,
    pâtisserie: /(flan|tarte|éclair|chou|mille[- ]feuille|fraisier|entremet|g[âa]teau|paris[- ]brest|tiramisu|op[eé]ra|macaron|petit\s*four)/i,
    traiteur: /(sandwich|pizza|salade|quiche|panini|wrap|burger|pasta|p[âa]tes|soupe|plat|traiteur|snack)/i,
    viennoiserie: /(croissant|pain au chocolat|chocolatine|brioche|chausson|pain aux raisins|cookie|donut|viennoiserie)/i,
    boissons: /(eau|min[ée]rale|coca|cola|boisson|jus|caf[ée]|th[ée]|bouteille|canette)/i
  };

  function detectCat(label){
    const s=String(label||'');
    if(RX.boulangerie.test(s)) return 'boulangerie';
    if(RX.pâtisserie.test(s)) return 'pâtisserie';
    if(RX.traiteur.test(s)) return 'traiteur';
    if(RX.viennoiserie.test(s)) return 'viennoiserie';
    return 'boulangerie';
  }

  function splitItems(text){
    const raw = String(text||'').split(/[\n;,·•\/|]+/);
    const out=[];
    raw.forEach(t=>{
      let x=t.trim(); if(!x) return;
      const m = x.match(/^\s*(\d+)?\s*(?:x|×)?\s*(.+?)(?:\s*\(\s*(boulangerie|pâtisserie|traiteur|viennoiserie)\s*\))?\s*$/i);
      const qty = m && m[1] ? m[1] : '';
      const label = m && m[2] ? m[2].trim() : x;
      const cat = (m && m[3]) ? m[3].toLowerCase() : detectCat(label);
      out.push({qty,label,category:cat});
    });
    return out;
  }

  function esc(s){ return String(s==null?'':s).replace(/[&<>\"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  function rebuildKitchenPerLine(){
    const root = document.getElementById('kitchen');
    if(!root) return;

    const days = root.querySelectorAll('section.day');
    days.forEach(day => {
      const origTickets = [...day.querySelectorAll('article.ticket')];
      if(!origTickets.length) return;

      const header = day.querySelector(':scope > h4');
      [...day.children].forEach(el => { if(!header || el !== header) el.remove(); });

      origTickets.forEach(t => {
        const cb = t.querySelector('[data-ready-toggle]');
        const id = cb ? cb.getAttribute('data-id') : null;
        const order = (window.orders||[]).find(x=> String(x.id)===String(id));
        const itemsEl = t.querySelector('.items') || t;
        const txt = itemsEl ? itemsEl.textContent : '';
        const lines = splitItems(txt);

        if(order){
          if(!Array.isArray(order.linesReady) || order.linesReady.length !== lines.length){
            order.linesReady = Array(lines.length).fill(false);
            if(typeof window.save==='function') window.save();
          }
        }

        const buckets = new Map(CATS.map(c=>[c,[]]));

        lines.forEach((L,i)=>{
          const n = t.cloneNode(true);
          const old = n.querySelector('.ready'); if(old) old.remove();
          const it = n.querySelector('.items') || n;
          it.textContent = (L.qty? (L.qty+' × ') : '') + L.label;

          let wrap = n.querySelector('.catwrap');
          if(!wrap){ wrap = document.createElement('div'); wrap.className='catwrap'; (n.querySelector('.items')||n).insertAdjacentElement('afterend', wrap); }
          wrap.innerHTML = `<span class="catchip">${esc(L.category)}</span>`;

          const checked = !!(order && order.linesReady && order.linesReady[i]);
          const label = document.createElement('label');
          label.className = 'ready';
          label.innerHTML = `<input type="checkbox" data-line-ready data-id="${esc(order?order.id:'')}" data-idx="${i}" ${checked?'checked':''}/> Produit prêt`;
          n.appendChild(label);
          if(checked) n.classList.add('line-ready');

          if(!buckets.has(L.category)) buckets.set(L.category,[]);
          buckets.get(L.category).push(n);
        });

        CATS.forEach(cat => {
          const arr=buckets.get(cat)||[]; if(!arr.length) return;
          const sub = document.createElement('div');
          sub.innerHTML = `<div class="subcat">${cat.charAt(0).toUpperCase()+cat.slice(1)} · <span class="pill">${arr.length}</span></div>`;
          arr.forEach(n => sub.appendChild(n));
          day.appendChild(sub);
        });
      });

      day.querySelectorAll('input[data-line-ready]').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const id = inp.getAttribute('data-id');
          const idx = Number(inp.getAttribute('data-idx')||0);
          const order = (window.orders||[]).find(x=> String(x.id)===String(id));
          if(!order) return;
          if(!Array.isArray(order.linesReady)) order.linesReady = [];
          order.linesReady[idx] = inp.checked;
          const card = inp.closest('article.ticket');
          if(card) card.classList.toggle('line-ready', inp.checked);
          if(typeof window.save==='function') window.save();
        });
      });

      day.querySelectorAll('[data-ready-toggle]').forEach(el=> el.remove());
    });
  }

  if(typeof window.renderKitchen==='function' && !window.renderKitchen.__perLineReadyWrapped){
    const orig = window.renderKitchen;
    window.renderKitchen = function(){
      try{ orig.apply(this, arguments); }catch(e){ console.error(e); }
      try{ rebuildKitchenPerLine(); }catch(e){ console.error(e); }
    };
    window.renderKitchen.__perLineReadyWrapped = true;
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', rebuildKitchenPerLine);
  }else{
    try{ rebuildKitchenPerLine(); }catch(e){ console.error(e); }
  }
})();
</script>


<script>
// === Production filters (safe) ===
(function(){
  const CATS=['boulangerie','pâtisserie','traiteur','viennoiserie','boissons'];
  function bar(host){
    const wrap=document.createElement('div'); wrap.className='catbar';
    CATS.forEach(c=>{
      const b=document.createElement('button'); b.className='catbtn'; b.textContent=c[0].toUpperCase()+c.slice(1);
      b.addEventListener('click',()=>{
        b.classList.toggle('active');
        const active=[...wrap.querySelectorAll('.catbtn.active')].map(x=>x.textContent.toLowerCase());
        document.querySelectorAll('#kitchen .subcat').forEach(h=>{
          const label=(h.textContent||'').toLowerCase();
          const match = active.length ? active.some(a=>label.startsWith(a)) : true;
          const block = h.parentElement;
          block.classList.toggle('hidden', !match);
        });
      });
      wrap.appendChild(b);
    });
    const reset=document.createElement('button'); reset.className='catbtn'; reset.textContent='Réinitialiser';
    reset.addEventListener('click',()=>{
      wrap.querySelectorAll('.catbtn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('#kitchen .subcat').forEach(h=>{ h.parentElement.classList.remove('hidden'); });
    });
    wrap.appendChild(reset);
    host.prepend(wrap);
  }
  function install(){
    const host=document.getElementById('kitchen');
    if(!host) return;
    if(host.querySelector('.catbar')) return;
    bar(host);
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', install); } else { install(); }
  const mo=new MutationObserver(()=>install()); mo.observe(document.documentElement,{childList:true,subtree:true});
})();
</script>







<script>
// === Inline Products v3 — lignes: label, qty, unit, category, note (Nouvelle commande seulement) ===
(function(){
  const ONCE='data-lines-editor-installed';
  const TARGETS=[
    '#items','textarea#items','[name="items"]','textarea[name^="items"]',
    'textarea[placeholder*="Produit"]','textarea[placeholder*="Produits"]',
    'textarea[aria-label*="Produit"]','textarea[aria-label*="Produits"]',
    'form textarea','dialog textarea','section textarea','textarea'
  ];
  const CATS=['boulangerie','pâtisserie','traiteur','viennoiserie','boissons'];
  const RX={
    boulangerie:/(?:\b|\s)(baguette|tradition|pain(?! au chocolat)|campagne|seigle|céréales|bâtard|ficelle|complet)(?:\b|\s)/i,
    pâtisserie:/(flan|tarte|éclair|chou|mille[- ]feuille|fraisier|entremet|g[âa]teau|paris[- ]brest|tiramisu|op[eé]ra|macaron|petit\s*four)/i,
    traiteur:/(sandwich|pizza|salade|quiche|panini|wrap|burger|pasta|p[âa]tes|soupe|plat|traiteur|snack)/i,
    viennoiserie:/(croissant|pain au chocolat|chocolatine|brioche|chausson|pain aux raisins|cookie|donut|viennoiserie)/i,
    boissons: /(eau|minerale|minérale|coca|cola|boisson|jus|café|cafe|thé|the|bouteille|canette)/i
  };
  const nf=new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});

  function detectCat(label){
    const s=String(label||'');
    if(RX.boulangerie.test(s)) return 'boulangerie';
    if(RX.pâtisserie.test(s)) return 'pâtisserie';
    if(RX.traiteur.test(s)) return 'traiteur';
    if(RX.viennoiserie.test(s)) return 'viennoiserie';
    return 'boulangerie';
  }
  function catOptions(sel){ return CATS.map(c=>`<option value="${c}" ${sel===c?'selected':''}>${c[0].toUpperCase()+c.slice(1)}</option>`).join(''); }
  function esc(s){ return String(s==null?'':s).replace(/[&<>\"']/g,(m)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function findAmountField(){
    const c=['#amount','input[name="amount"]','input#total','input[name*="total"]','input[placeholder*="Montant"]','input[placeholder*="Total"]'];
    for(const sel of c){ const el=document.querySelector(sel); if(el) return el; } return null;
  }

  function build(itemsEl){
    // assure contexte "Nouvelle commande"
    const ctx = itemsEl.closest('div,section,form,dialog') || document;
    const heading = ctx.querySelector('h1,h2,h3,[role="heading"]');
    if(!(heading && /nouvelle commande/i.test(heading.textContent||''))) return false;
    if(itemsEl.getAttribute(ONCE)) return true;
    itemsEl.setAttribute(ONCE,'1');
    itemsEl.style.display='none';

    const box=document.createElement('div'); box.className='lines-box';
    box.innerHTML=`
      <div class="lines-grid">
        <div class="hdr">Dénomination</div>
        <div class="hdr">Qté</div>
        <div class="hdr">Prix (unité)</div>
        <div class="hdr">Catégorie</div>
        <div class="hdr">Note</div>
      </div>
      <div id="lnRows" class="lines-grid"></div>
      <div class="lines-actions"><button class="lem-btn" id="lnAdd" type="button">Ajouter une ligne</button></div>
      <div class="lines-sums"><span class="lines-pill">Total TTC: <span id="lnTTC">0,00 €</span></span></div>
    `;
    itemsEl.insertAdjacentElement('afterend', box);

    function addRow(data){
      data=data||{label:'',qty:1,unit:0,cat:'',note:''};
      if(!data.cat){ data.cat = detectCat(data.label); }
      const r=document.createElement('div'); r.className='lines-row';
      r.innerHTML = `
        <input type="text" data-k="label" placeholder="Dénomination" value="${esc(data.label||'')}">
        <input type="number" data-k="qty" min="0" step="1" value="${Number(data.qty||1)}">
        <input type="number" data-k="unit" min="0" step="0.01" value="${Number(data.unit||0)}">
        <select data-k="cat">${catOptions(String(data.cat||''))}</select>
        <textarea data-k="note" placeholder="Notes…">${esc(data.note||'')}</textarea>
      `;
      const rm=document.createElement('div'); rm.style.gridColumn='1/-1'; rm.style.display='flex'; rm.style.justifyContent='flex-end';
      rm.innerHTML = `<button class="lem-btn" type="button">Supprimer</button>`;
      rm.firstElementChild.addEventListener('click',()=>{ r.remove(); rm.remove(); recalc(); });
      document.getElementById('lnRows').appendChild(r);
      document.getElementById('lnRows').appendChild(rm);
    }

    function collect(){
      const rows=[...document.querySelectorAll('#lnRows .lines-row')];
      return rows.map(r=>{
        const get=k=>{ const e=r.querySelector(\`[data-k="${k}"]\`); return e?e.value:''; };
        const label=get('label');
        const catSel=get('cat')||detectCat(label);
        return { label, qty:Number(get('qty')||0), unit:Number(get('unit')||0), cat:catSel, note:get('note') };
      }).filter(x=>String(x.label||'').trim().length);
    }

    function updateBackings(lines){
      // Texte pour "Produits"
      const items = lines.map(l=> \`\${Number(l.qty||0)} × \${l.label} (\${l.cat})\`).join(' · ');
      itemsEl.value = items;
      try{ itemsEl.dataset.lines = JSON.stringify(lines); }catch(e){}
      // Montant
      const total = lines.reduce((s,l)=> s + Number(l.qty||0)*Number(l.unit||0), 0);
      const amt=findAmountField(); if(amt){ amt.value = String(total.toFixed(2)); }
      document.getElementById('lnTTC').textContent = nf.format(total);
    }

    function recalc(){ updateBackings(collect()); }

    document.getElementById('lnAdd').addEventListener('click', ()=>{ addRow({}); recalc(); });
    document.getElementById('lnRows').addEventListener('input', recalc);
    document.getElementById('lnRows').addEventListener('change', recalc);

    // Initialise depuis le texte existant si présent
    const txt=String(itemsEl.value||'').trim();
    if(txt){
      const parts=txt.split(/[\\n;,\\u00B7\\u2022\\/|]+/);
      let any=false;
      parts.forEach(t=>{
        const x=t.trim(); if(!x) return;
        const m=x.match(/^\\s*(\\d+)?\\s*(?:x|×)?\\s*(.+?)(?:\\s*\\(\\s*(boulangerie|pâtisserie|traiteur|viennoiserie)\\s*\\))?\\s*$/i);
        if(m){
          const qty=m[1]? Number(m[1]) : 1;
          const label=m[2]? m[2].trim() : x;
          const cat=m[3]? String(m[3]).toLowerCase() : detectCat(label);
          addRow({label, qty, unit:0, cat}); any=true;
        }
      });
      if(!any) addRow({label:txt});
    }else{
      addRow({});
    }
    recalc();
    return true;
  }

  function tryInstall(){
    let installed=false;
    for(const sel of TARGETS){
      const nodes=document.querySelectorAll(sel);
      for(const el of nodes){
        if(el && !el.getAttribute(ONCE)){
          const ok = build(el);
          if(ok){ installed=true; break; }
        }
      }
      if(installed) break;
    }
    return installed;
  }

  function boot(){
    const ok = tryInstall();
    // si installé, on débranche l'observer pour éviter les ré-injections
    if(ok && window.__ILE_OBS){ try{ window.__ILE_OBS.disconnect(); }catch(_){ } }
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
  window.__ILE_OBS = new MutationObserver(()=>boot());
  try{ window.__ILE_OBS.observe(document.documentElement,{childList:true,subtree:true}); }catch(_){}
})();
</script>


<script>
// === Line Builder (safe, non-intrusif) ===
(function(){
  // Utilities from main script expected: byId, val, setVal
  function escapeHtml(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function num(n){ const x = Number(n); return isFinite(x) ? x : 0; }

  let tmpLines = [];

  function getCats(){
    const btns = Array.from(document.querySelectorAll('.catbtn')).map(b=> (b.textContent||'').trim().toLowerCase());
    const uniq = Array.from(new Set(btns)).filter(Boolean);
    if (uniq.length) return uniq;
    return ['boulangerie','pâtisserie','traiteur','viennoiserie','boissons'];
  }

  function fillLineCat(){
    const sel = byId('lineCat'); if(!sel) return;
    const cats = getCats();
    sel.innerHTML = '<option value="">— Catégorie —</option>' + cats.map(c=>{
      const label = c.charAt(0).toUpperCase() + c.slice(1);
      return `<option value="${escapeHtml(c)}">${escapeHtml(label)}</option>`;
    }).join('');
  }

  function renderLinesTable(){
    const host = byId('linesTable'); if(!host) return;
    if (!tmpLines.length) {
      host.innerHTML = `<p class="muted">Aucune ligne pour le moment.</p>`;
      return;
    }
    const rows = tmpLines.map((l,i)=>`
      <tr>
        <td style="width:36px;text-align:center">${i+1}</td>
        <td>${escapeHtml(l.name)}</td>
        <td style="width:80px;text-align:right">${l.qty}</td>
        <td style="width:140px">${escapeHtml(l.category||'—')}</td>
        <td style="width:100px;text-align:right">${l.price!=='' && l.price!=null ? num(l.price).toFixed(2) : '—'}</td>
        <td style="width:110px;text-align:right">${(num(l.price)*num(l.qty) || 0).toFixed(2)}</td>
        <td style="width:120px;text-align:right"><button class="btn danger xs" data-del="${i}">Supprimer</button></td>
      </tr>
    `).join('');
    host.innerHTML = `<table>
      <thead><tr>
        <th>#</th><th>Produit</th><th>Qté</th><th>Cat.</th><th>Prix</th><th>Total</th><th></th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
    host.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-del'));
        if (!isNaN(i)) { tmpLines.splice(i,1); syncItemsAndAmount(); }
      });
    });
  }

  function syncItemsAndAmount(){
    const txt = tmpLines.map(l => `${num(l.qty)||1} ${l.name}`.trim()).join('; ');
    setVal('fItems', txt);
    // auto amount only if empty or 0 (ne pas forcer si l'utilisateur a saisi sa valeur)
    const auto = tmpLines.reduce((s,l)=> s + num(l.qty)*num(l.price), 0);
    const cur = num(val('fAmount'));
    if (!cur) setVal('fAmount', auto ? auto.toFixed(2) : '');
    renderLinesTable();
  }

  function addLineFromForm(){
    const name = (val('lineName')||'').trim();
    let qty = Math.max(1, Math.floor(num(val('lineQty')||1)));
    const category = val('lineCat') || '';
    const priceStr = val('linePrice');
    const price = priceStr === '' ? '' : num(priceStr);
    if (!name) { alert('La dénomination est obligatoire.'); return; }
    tmpLines.push({name, qty, category, price});
    setVal('lineName',''); setVal('lineQty','1'); setVal('linePrice','');
    syncItemsAndAmount();
  }

  function resetLines(){
    tmpLines = []; syncItemsAndAmount();
  }

  // Wire up on ready
  function ready(){
    fillLineCat();
    renderLinesTable();
    const add = byId('addLine'); if (add) add.addEventListener('click', addLineFromForm);
    const r1 = byId('resetForm'); if (r1) r1.addEventListener('click', resetLines);
    const c1 = byId('closeModal'); if (c1) c1.addEventListener('click', resetLines);
    const o1 = byId('openNewOrder'); if (o1) o1.addEventListener('click', ()=>{ resetLines(); fillLineCat(); });
  }
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', ready); } else { ready(); }
})();
</script>


<script>
// --- Fix: delegated ready toggle sync to Tableau ('à livrer') ---
(function(){
  function onChange(e){
    const t = e.target;
    if (!(t && t.matches && t.matches('input[type="checkbox"][data-ready-toggle]'))) return;
    const id = t.dataset.id;
    if (!id || !window.orders) return;
    const o = window.orders.find(x => String(x.id) === String(id));
    if (!o) return;
    if (t.checked){
      o.status = 'a_livrer';
      o.readyAt = new Date().toISOString();
    } else {
      // retourne en "à préparer" si décoché
      o.status = 'a_preparer';
      o.readyAt = null;
    }
    if (typeof window.save === 'function') window.save();
    if (typeof window.renderBoard === 'function') window.renderBoard();
    if (typeof window.renderKitchen === 'function') window.renderKitchen();
  }
  document.addEventListener('change', onChange);
})();
</script>


<script>
// --- Robust sync for "Commande prête" -> a_livrer in Board ---
(function(){
  function getOrders(){
    try { return orders; } catch(e){ return window.orders; }
  }
  function findOrderById(id){
    const arr = getOrders(); if (!arr) return null;
    return arr.find(x => String(x.id) === String(id));
  }
  function findOrderFromDom(input){
    // Try dataset id first
    if (input && input.dataset && input.dataset.id) {
      return findOrderById(input.dataset.id);
    }
    // Try ancestor with data-id
    const host = input.closest('[data-id]');
    if (host && host.getAttribute) {
      return findOrderById(host.getAttribute('data-id'));
    }
    return null;
  }
  function handleToggle(t){
    const ord = findOrderFromDom(t);
    if (!ord) return;
    if (t.checked){
      ord.status = 'a_livrer';
      ord.readyAt = new Date().toISOString();
    } else {
      ord.status = 'a_preparer';
      ord.readyAt = null;
    }
    if (typeof save === 'function') save();
    if (typeof renderBoard === 'function') renderBoard();
    if (typeof renderKitchen === 'function') renderKitchen();
  }
  function delegated(e){
    const t = e.target;
    if (!t || !t.matches) return;
    if (t.matches('input[type="checkbox"][data-ready-toggle], #kitchen label.ready input[type="checkbox"]')){
      handleToggle(t);
    }
  }
  // Delegate globally
  document.addEventListener('change', delegated);
  // Also ensure we re-bind after every kitchen render
  const _rk = window.renderKitchen;
  if (typeof _rk === 'function'){
    window.renderKitchen = function(){
      _rk.apply(this, arguments);
      // Nothing else to bind, we use delegated handler
    };
  }
})();
</script>


<script id="patch-mobile-js">
(function(){
  function $(sel,root){ return (root||document).querySelector(sel); }
  function $all(sel,root){ return Array.from((root||document).querySelectorAll(sel)); }

  // Menu hamburger
  var hamb = $('#hamburger');
  var menu = $('#mobileMenu');
  if (hamb && menu){
    hamb.addEventListener('click', function(){
      var open = !document.body.classList.contains('menu-open');
      document.body.classList.toggle('menu-open', open);
      hamb.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
    // Fermer en cliquant le backdrop
    menu.addEventListener('click', function(e){
      if (e.target === menu){ document.body.classList.remove('menu-open'); hamb.setAttribute('aria-expanded','false'); }
    });
    // Tabs (redirige vers onglets existants)
    $all('[data-menu-tab]').forEach(function(btn){
      btn.addEventListener('click', function(){
        var tab = btn.getAttribute('data-menu-tab');
        var real = document.querySelector('.top-left .nav .tab[data-tab="'+tab+'"]');
        if (real) real.click();
        document.body.classList.remove('menu-open'); hamb.setAttribute('aria-expanded','false');
      });
    });
    // Actions (redirige vers boutons existants)
    $all('[data-menu-click]').forEach(function(btn){
      btn.addEventListener('click', function(){
        var sel = btn.getAttribute('data-menu-click');
        var real = $(sel);
        if (real) real.click();
        document.body.classList.remove('menu-open'); hamb.setAttribute('aria-expanded','false');
      });
    });
  }

  // Corrige la case "Commande prête" (Production) -> envoie vers "À livrer"
  document.addEventListener('change', function(e){
    var t = e.target;
    if (!t || !t.matches('[data-ready-toggle]')) return;
    try{
      var id = String(t.getAttribute('data-id')||'').trim();
      if (!id) return;
      if (!window.orders || !Array.isArray(window.orders)) return;
      var o = window.orders.find(function(x){ return String(x.id)===id; });
      if (!o) return;
      if (t.checked){
        o.status='a_livrer';
        o.readyAt = new Date().toISOString();
      } else {
        o.status='a_preparer';
        o.readyAt = null;
      }
      if (typeof window.save==='function') window.save();
      if (typeof window.renderBoard==='function') window.renderBoard();
      if (typeof window.renderKitchen==='function') window.renderKitchen();
    }catch(_){}
  });
})();
</script>

</body>
</html>